<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Easier Bib</title>
</head>
<body>
    <h1>Welcome to Easier Bib</h1>

    <!-- ######################## START AUTO-FILL ######################## -->

    <!-- Fills form with URL Auto-fill data -->
    <h2>Auto-fill with URL</h2>
    <input type="text" id="url-input" placeholder="Enter a website URL (e.g. https://example.com)">
    <button onclick="fetchURLData()">Fetch Data</button><br>
    <p id="url-status">Status...</p>

    <!-- Fills form with ISBN Auto-fill data -->
    <h2>Auto-fill with ISBN</h2>
    <input type="text" id="isbn-input" placeholder="Enter ISBN (e.g. 9780140328721)">
    <button onclick="fetchISBNData()">Fetch Data</button><br>
    <p id="isbn-status">Status...</p>

    <!-- Fills form with DOI Auto-fill data -->
    <h2>Auto-fill with DOI</h2>
    <input type="text" id="doi-input" placeholder="Enter DOI (e.g. 10.1234/abc123)"> 
    <button onclick="fetchDOIData()">Fetch Data</button><br>
    <p id="doi-status">Status...</p>

    <!-- ######################### END AUTO-FILL ######################### -->

    <!-- #################### START MANUAL ENTRY FORM #################### -->
    <form method="POST" action="/">

        <label for="source_type">Source Type:</label>
        <select name="source_type" id="source_type" required>
            <option value="book">Book</option>
            <option value="website">Website</option>
        </select><br>


        <!-- Dropdown for selecting citation style -->
        <label>Citation Style:</label>
        <select name="style" id="style">
            <option value="MLA">MLA</option>
            <option value="APA">APA</option>
        </select><br><br>

        <!-- Fields for putting information used for citation -->
        <label for="author">Author:</label>
        <input type="text" name="author" id="author"><br><br>

        <label for="title">Title:</label>
        <input type="text" name="title" id="title" required><br><br>
 
        <label for="year">Year:</label>
        <input type="text" name="year" id="year"><br><br>

        <label for="publisher">Publisher:</label>
        <input type="text" name="publisher" id="publisher"><br><br>

        <!-- Additional fields for website citations. CURRENTLY NOT REQUIRED! -->
        <label for="url">URL:</label>
        <input type="url" name="url"><br><br>

        <label for="access_date">Access Date:</label>
        <input type="text" name="access_date" placeholder="e.g. April 10, 2025"><br><br>


        <button type="sumbit">Generate Citation</button>
    </form>
    <!-- ##################### END MANUAL ENTRY FORM ##################### -->


    <!-- This is Jinja2, the templating language Flask uses to 
        embed Python logic into HTML. This makes it so it only shows
        the Generated Citation section if the user submitted info -->
    {% if citation %}
        <h2>Generated Citation:</h2>

        <!-- Putting '|safe' after citation tells Jinja that this string is trusted, 
            and to render any HTML tags in it as actual HTML, not just text -->
        <p id="citation-output">{{ citation|safe }}</p>
        <button onclick="copyCitation()">Copy Citation</button>
    {% endif %}


        <!-- ########################################################################### -->
        <!-- ############################# START JAVASCRIPT ############################ -->
        <!-- ########################################################################### -->


        <!-- Javascript function to copy citation to clipboard. Makes 'copy' button work -->
        <script>
            function copyCitation() {
                // Gets the HTML element containing the citation HTML
                const citationElement = document.getElementById("citation-output");
                const html = citationElement.innerHTML; // Preserves HTML formatting tags like italics <i> and bold <b>
                const text = citationElement.innerText; // Plain text version for places that don't support formatting
            
                // Wraps each version in a Blob. This is like a lightweight file in memory.
                // Each blob has data that is used to determine which blob to paste.
                const blobHTML = new Blob([html], { type: "text/html" });
                const blobText = new Blob([text], { type: "text/plain" });
            
                // Creats a ClipboardItem that holds both formats. Pasted location determines which to use.
                const clipboardItem = new ClipboardItem({
                    "text/html": blobHTML,
                    "text/plain": blobText
                });
            
                // Writes item to clipboard, and shows success or error message.
                navigator.clipboard.write([clipboardItem]).then(function() {
                    alert("Citation copied with formatting!");
                }, function(err) {
                    alert("Failed to copy citation.");
                    console.error(err);
                });
            }
            </script>

        <!-- ############################# START FETCH DOI DATA ############################ -->
             <script>
                function fetchDOIData() {
                    // Grabs DOI input field and shows a status message
                    const doi = document.getElementById("doi-input").value; 
                    document.getElementById("doi-status").innerText = "Looking up DOI..."

                    // Sends a POST request to Flask backend with the DOI in JSON format
                    fetch("/lookup-doi", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({doi: doi})
                    })
                    // Parses the response, checks for an error, and updates page accordingly
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            document.getElementById("doi-status").innerText = "Error: " + data.error;
                        } else {
                            document.getElementById("doi-status").innerText = "DOI data loaded!";

                            // If successful, fills in the form with the fetched citation data
                            document.querySelector("[name='author']").value = data.author;
                            document.querySelector("[name='title']").value = data.title;
                            document.querySelector("[name='year']").value = data.year;
                            document.querySelector("[name='publisher']").value = data.publisher;
                        }
                    });
                }
             </script>
        <!-- ############################# END FETCH DOI DATA ############################ -->


        <!-- ############################# START FETCH ISBN DATA ############################ -->
             <script>
                function fetchISBNData() {
                    // Grabs ISBN input field and shows a status message
                    const isbn = document.getElementById("isbn-input").value.trim();
                    document.getElementById("isbn-status").innerText = "Looking up ISBN...";
                
                    // Sends a POST request to Flask backend with the ISBN in JSON format
                    fetch("/lookup-isbn", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ isbn: isbn })
                    })
                    // Parses the response, checks for an error, and updates page accordingly
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            document.getElementById("isbn-status").innerText = "Error: " + data.error;
                        } else {
                            document.getElementById("isbn-status").innerText = "ISBN data loaded!";

                            // If successful, fills in the form with the fetched citation data
                            document.querySelector("[name='author']").value = data.author;
                            document.querySelector("[name='title']").value = data.title;
                            document.querySelector("[name='year']").value = data.year;
                            document.querySelector("[name='publisher']").value = data.publisher;
                        }
                    });
                }
            </script>
        <!-- ############################## END FETCH ISBN DATA ############################# -->


        <!-- ############################## START FETCH URL DATA ############################# -->
            <script>
                function fetchURLData() {
                    // Grabs URL input field and shows a status message
                    const url = document.getElementById("url-input").value;
                    document.getElementById("url-status").innerText = "Looking up URL...";
                
                    // Sends a POST request to Flask backend with the ISBN in JSON format
                    fetch("/lookup-url", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ url: url })
                    })
                    // Parses the response, checks for an error, and updates page accordingly
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            document.getElementById("url-status").innerText = "Error: " + data.error;
                        } else {
                            document.getElementById("url-status").innerText = "URL data loaded!";
                            document.querySelector("[name='author']").value = data.author;
                            document.querySelector("[name='title']").value = data.title;
                            document.querySelector("[name='year']").value = data.year;
                            document.querySelector("[name='publisher']").value = data.publisher;
                            document.querySelector("[name='url']").value = data.url;

                        }
                    })
                    // If successful, fills in the form with the fetched citation data
                    .catch(err => {
                        document.getElementById("url-status").innerText = "Error fetching data.";
                        console.error(err);
                    });
                }
                </script>
        <!-- ############################### END FETCH URL DATA ############################## -->

    
    <!-- ########################################################################### -->
    <!-- ############################## END JAVASCRIPT ############################# -->
    <!-- ########################################################################### -->


</body>
</html>
